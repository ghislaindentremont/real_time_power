---
title: "PSYO 6001 Final Project - Ghislain d'Entremont"
author: Ghislain d'Entremont
date: March 18, 2017
output: html_document
---

# Data Processing

## Load Packages 

```{r message=FALSE}
library(signal)
library(tidyverse)
library(rstan)
library(bspec)
```

## Load and Tidy Data

```{r message=FALSE}
setwd("/Volumes/LaCie/Experiments/NF_data/Piloting")

raw = map_df(
  .x = list.files(
    pattern = "p101_raw"
  )
  , .f = function(file) {
    read_csv(
      file = file
      , col_names = FALSE
    )
  }
)

names(raw) = c('id', 'age', 'sex', 'hand', 'year', 'month', 'day', 'hour', 'minute', 'seconds', 'block' , 'block_cond', 'trial', 'cue_loc', 'iti', 'trial_stage', 'iteration', 'time', 'Ch1', 'Ch2', 'Ch3', 'Ch4', 'Ch5', 'Ch6', 'Ch7', 'Ch8', 'Ch9', 'Ch10', 'Ch11', 'Ch12', 'Ch13', 'Ch14')

raw$id = factor(raw$id)
raw$sex = factor(raw$sex, levels = c(1, 2), labels = c("male", "female"))
raw$hand = factor(raw$hand, levels = c(1, 2), labels = c("left", "right"))
raw$block = factor(raw$block, levels = c(1:5), labels = c("1", "2", "3", "4", "5"))
raw$block_cond = factor(raw$block_cond, levels = c(1, 2), labels = c("MI", "ME"))
raw$cue_loc = factor(raw$cue_loc, levels = c(1, 2), labels = c("left", "right"))
raw$trial_stage = factor(raw$trial_stage, levels = c(1:4), labels = c("iti", "fixation", "cue", "NF"))

raw_long = raw %>%
  gather(channel, signal, Ch1:Ch14, factor_key = TRUE)
```

##### Add adjusted time column that starts at zero for each trial for epochs later. We will be using estimated time based on the EEG system's sampling frequency (128 Hz). Therefore, we confirm that the estimated and actual timestamps don't differ substantially. Indeed, the timestamps are accurate to within 10 ms. 

```{r}
raw_long = raw_long %>%
  group_by(block_cond, block, trial, trial_stage, channel) %>%
  mutate(
    time_adj = time - min(time)
    , time_est = seq(0, (1/128)*(length(id)-1), by = 1/128)
    )

range(raw_long$time_est - raw_long$time_adj)
```

##### Acknowledge timing issue: there appears to be a time lag in the latter half of each block, specifically in the cue presentation trial stages. I'm unsure as to why right now. It is very consistent, so it may be a systematic error in the code. Specifically, the time seems to double...  

```{r}
raw_long %>%
  group_by(block_cond, block, trial, trial_stage) %>%
  summarize(max_time = max(time_est)) %>%
  filter(block != "1", trial_stage != "iti") %>%
  mutate(time_stage = (as.numeric(block) - 2) * 60 + as.numeric(trial)) %>%
  group_by(block_cond, time_stage, trial_stage) %>%
  ggplot()+
    geom_point(aes(x=time_stage, y=max_time))+
    facet_grid(block_cond~trial_stage)+
    ylab("Time of Trial Stage (s)")+
    xlab("Overall Trial Count (Out of 240)")
```

##### Filter data

```{r}
bu2 = butter(6, c(13,30)/(128/2), type = 'pass')

filtered = raw_long %>%
  group_by(block_cond, channel) %>%
  mutate(butter_filtered = signal::filter(bu2, signal)) %>%
  mutate(power = as.numeric(butter_filtered)^2)
```

##### Get rid of practice block

```{r}
filtered = filtered %>%
  filter(block != "1")
```

# ERD Timecourses

## (Log of Average/Average of log of Power) over Moving Average Baseline

##### Get moving average baseline 

```{r}
baselines = filtered %>%
  dplyr::filter(trial_stage == "fixation", channel == "Ch8" | channel == "Ch12") %>%
  group_by(block_cond, block, trial) %>%
  summarize(baseline = mean(power))

baselines = baselines %>%
  filter(!is.na(baseline))

WINDOW_SIZE = 40

mavgs = NULL
for (i in 1:nrow(baselines)) {

  if (baselines$block[i] == 2 & baselines$trial[i] == 1) {
    window = NULL
  }

  window = c(baselines$baseline[i], window)

  if (length(window) > WINDOW_SIZE) {
      window_40 = window[1:WINDOW_SIZE]
  } else {
    window_40 = window
  }

  mavg = mean(window_40)
  mavgs = c(mavgs, mavg)
}

mavgs_tibb = tibble(block_cond = baselines$block_cond,  block = baselines$block, trial = baselines$trial, mavg = mavgs)
```

##### Get relative power

```{r}
for_ERD = filtered %>%
  dplyr::filter(trial_stage != "iti", channel == "Ch8" | channel == "Ch12") %>%
  mutate(laterality = ifelse(
    (cue_loc == "right" & channel == "Ch8") | (cue_loc == "left" & channel == "Ch12")
      , "contra"
      , "ipsi"
    )
  ) %>%
  group_by(block_cond, block, trial, laterality) %>%
  mutate(
  time_est_ERD = seq(0, (1/128)*(length(id)-1), by = 1/128)
  ) %>%
  left_join(mavgs_tibb) %>%
  mutate(
    relative_power = (power/mavg)
    , log_relative_power = log2(relative_power)
  )
```

### Log of Average over Moving Average Baseline

```{r}
for_ERD %>%
  group_by(block_cond, time_est_ERD, laterality) %>%
  summarize(avg_relative_power = mean(relative_power, na.rm = T)) %>%
  group_by(block_cond, laterality) %>%
  mutate(sma_relative_power = stats::filter(avg_relative_power, rep(1/128, 128), sides=2)) %>%
  mutate(log_sma_relative_power = log(sma_relative_power)) %>%
  mutate(log_avg_relative_power = log(avg_relative_power)) %>%
  ggplot()+
    geom_line(aes(x=time_est_ERD, y=log_avg_relative_power, color = laterality), alpha = 0.2)+
    geom_line(aes(x=time_est_ERD, y=log_sma_relative_power, color = laterality))+
    facet_grid(.~block_cond)+
    xlab("Trial Time (s)")+
    ylab("Log2 of Average Relative Power")+
    ggtitle("All Trials") +
    geom_vline(xintercept = 2, linetype = "dashed")+
    geom_vline(xintercept = 2 + 1.25, linetype = "dashed")+
    geom_hline(yintercept=0, linetype = "dashed")+
    ylim(c(-1, 1))  # no avoid outlying noise at the end

for_ERD %>%
  filter(trial <= 30) %>%
  group_by(block_cond, time_est_ERD, laterality) %>%
  summarize(avg_relative_power = mean(relative_power, na.rm = T)) %>%
  group_by(block_cond, laterality) %>%
  mutate(sma_relative_power = stats::filter(avg_relative_power, rep(1/128, 128), sides=2)) %>%
  mutate(log_sma_relative_power = log(sma_relative_power)) %>%
  mutate(log_avg_relative_power = log(avg_relative_power)) %>%
  ggplot()+
    geom_line(aes(x=time_est_ERD, y=log_avg_relative_power, color = laterality), alpha = 0.2)+
    geom_line(aes(x=time_est_ERD, y=log_sma_relative_power, color = laterality))+
    facet_grid(.~block_cond)+
    xlab("Trial Time (s)")+
    ylab("Log2 of Average Relative Power")+
    ggtitle("First 30 Trials") +
    geom_vline(xintercept = 2, linetype = "dashed")+
    geom_vline(xintercept = 2 + 1.25, linetype = "dashed")+
    geom_hline(yintercept=0, linetype = "dashed")+
    ylim(c(-1, 1))  # no avoid outlying noise at the end
```

### Average of Log over Moving Average Baseline

##### Taking the average of the logs spits out values centered around -2 on the y-axis. This is not ideal.

```{r}
for_ERD %>%
  group_by(block_cond, time_est_ERD, laterality) %>%
  summarize(avg_log_relative_power = mean(log_relative_power, na.rm = T)) %>%
  group_by(block_cond, laterality) %>%
  mutate(sma_log_relative_power = stats::filter(avg_log_relative_power, rep(1/128, 128), sides=2)) %>%
  ggplot()+
    geom_line(aes(x=time_est_ERD, y=avg_log_relative_power, color = laterality), alpha = 0.2)+
    geom_line(aes(x=time_est_ERD, y=sma_log_relative_power, color = laterality))+
    facet_grid(.~block_cond)+
    xlab("Trial Time (s)")+
    ylab("Average of Log2 of Relative Power")+
    ggtitle("All Trials") +
    geom_vline(xintercept = 2, linetype = "dashed")+
    geom_vline(xintercept = 2 + 1.25, linetype = "dashed")+
    geom_hline(yintercept=0, linetype = "dashed")+
    ylim(c(-4, 0))

for_ERD %>%
  filter(trial <= 30) %>%
  group_by(block_cond, time_est_ERD, laterality) %>%
  summarize(avg_log_relative_power = mean(log_relative_power, na.rm = T)) %>%
  group_by(block_cond, laterality) %>%
  mutate(sma_log_relative_power = stats::filter(avg_log_relative_power, rep(1/128, 128), sides=2)) %>%
  ggplot()+
    geom_line(aes(x=time_est_ERD, y=avg_log_relative_power, color = laterality), alpha = 0.2)+
    geom_line(aes(x=time_est_ERD, y=sma_log_relative_power, color = laterality))+
    facet_grid(.~block_cond)+
    xlab("Trial Time (s)")+
    ylab("Average of Log2 of Relative Power")+
    ggtitle("First 30 Trials") +
    geom_vline(xintercept = 2, linetype = "dashed")+
    geom_vline(xintercept = 2 + 1.25, linetype = "dashed")+
    geom_hline(yintercept=0, linetype = "dashed")+
    ylim(c(-4, 0))
```

## Percent ERD after Averaging across Trials (Zich & Pfurtscheller)

##### We create an average baseline for each block condition!

```{r}
avg_baselines = baselines %>%
  group_by(block_cond) %>%
  summarize(avg_baseline = mean(baseline))

avg_baselines_30 = baselines %>%
  filter(trial <= 30) %>%
  group_by(block_cond) %>%
  summarize(avg_baseline = mean(baseline))
```

##### Average power samples across trial, then get % ERD and plot  

```{r}
filtered %>%
  dplyr::filter(trial_stage != "iti", channel == "Ch8" | channel == "Ch12") %>%
  mutate(laterality = ifelse(
    (cue_loc == "right" & channel == "Ch8") | (cue_loc == "left" & channel == "Ch12")
      , "contra"
      , "ipsi"
    )
  ) %>%
  group_by(block_cond, block, trial, laterality) %>%
  mutate(
    time_est_ERD = seq(0, (1/128)*(length(id)-1), by = 1/128)
    ) %>%
  group_by(block_cond, time_est_ERD, laterality) %>% 
  summarize(avg_power = mean(power)) %>%
  left_join(avg_baselines) %>%
  group_by(block_cond, laterality) %>%
  mutate(sma_power = stats::filter(avg_power, rep(1/128, 128), sides=2)) %>%
  mutate(sma_percent_ERD = ((as.numeric(sma_power) - avg_baseline)/avg_baseline) * 100)%>%
  mutate(percent_ERD = ((avg_power - avg_baseline)/avg_baseline) * 100) %>%
  ggplot()+
    geom_line(aes(x=time_est_ERD, y=percent_ERD, color = laterality), alpha = 0.2)+
    geom_line(aes(x=time_est_ERD, y=sma_percent_ERD, color = laterality))+
    facet_grid(.~block_cond)+
    xlab("Trial Time (s)")+
    ylab("Percent ERD")+
    ggtitle("All Trials")+
    geom_vline(xintercept = 2, linetype = "dashed")+
    geom_vline(xintercept = 2 + 1.25, linetype = "dashed")+
    geom_hline(yintercept=0, linetype = "dashed")+
    ylim(c(-50,50))


filtered %>%
  dplyr::filter(trial_stage != "iti", channel == "Ch8" | channel == "Ch12", trial <= 30) %>%
  mutate(laterality = ifelse(
    (cue_loc == "right" & channel == "Ch8") | (cue_loc == "left" & channel == "Ch12")
      , "contra"
      , "ipsi"
    )
  ) %>%
  group_by(block_cond, block, trial, laterality) %>%
  mutate(
    time_est_ERD = seq(0, (1/128)*(length(id)-1), by = 1/128)
    ) %>%
  group_by(block_cond, time_est_ERD, laterality) %>% 
  summarize(avg_power = mean(power)) %>%
  left_join(avg_baselines_30) %>%
  group_by(block_cond, laterality) %>%
  mutate(sma_power = stats::filter(avg_power, rep(1/128, 128), sides=2)) %>%
  mutate(sma_percent_ERD = ((as.numeric(sma_power) - avg_baseline)/avg_baseline) * 100)%>%
  mutate(percent_ERD = ((avg_power - avg_baseline)/avg_baseline) * 100) %>%
  ggplot()+
    geom_line(aes(x=time_est_ERD, y=percent_ERD, color = laterality), alpha = 0.2)+
    geom_line(aes(x=time_est_ERD, y=sma_percent_ERD, color = laterality))+
    facet_grid(.~block_cond)+
    xlab("Trial Time (s)")+
    ylab("Percent ERD")+
    ggtitle("First 30 Trials")+
    geom_vline(xintercept = 2, linetype = "dashed")+
    geom_vline(xintercept = 2 + 1.25, linetype = "dashed")+
    geom_hline(yintercept=0, linetype = "dashed")+
    ylim(c(-50,50))
```




